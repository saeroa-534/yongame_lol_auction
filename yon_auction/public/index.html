<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>연낳대 경매 테스트</title>
  </head>
  <body>
    <h1>연낳대 경매 테스트</h1>

    <div id="status"></div>
    <div><b>현재 대상:</b> <span id="item">-</span></div>
    <div><b>최고가:</b> <span id="highest">-</span></div>
    <div><b>남은 시간:</b> <span id="timer">-</span></div>

    <hr />

    <input id="name" placeholder="이름" />
    <input id="price" type="number" placeholder="입찰가" />
    <button id="btn">입찰</button>

    <div id="msg" style="margin-top:8px;"></div>

    <hr />

    <div id="admin" style="display:none;">
      <h3>관리자</h3>
      <button id="start">경매 시작</button>
      <button id="end">강제 마감(낙찰/유찰 처리)</button>
      <button id="reset">리셋</button>
      <p>관리자 화면은 <code>/?admin=1</code> 로 접속하면 보입니다.</p>
    </div>

    <h3>낙찰 결과</h3>
    <pre id="results"></pre>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const params = new URLSearchParams(location.search);
      const isAdmin = params.get("admin") === "1";

      const socket = io({ auth: { role: isAdmin ? "admin" : "viewer" } });

      const $ = (sel) => document.querySelector(sel);
      const status = $("#status");
      const item = $("#item");
      const highest = $("#highest");
      const timer = $("#timer");
      const results = $("#results");
      const msg = $("#msg");

      if (isAdmin) $("#admin").style.display = "block";

      function setMsg(text) {
        msg.textContent = text;
        setTimeout(() => (msg.textContent = ""), 2000);
      }

      function renderState(s) {
        status.textContent = `phase=${s.phase} (${s.index + 1}/${s.total})`;
        item.textContent = s.item ?? "(끝)";
        highest.textContent = s.highestBidder
          ? `${s.highestBidder} - ${s.highestBid}`
          : "(아직 없음)";

        // 결과
        results.textContent = (s.results || [])
          .map((r, i) => `${i + 1}. ${r.item} / ${r.winner ?? "유찰"} / ${r.price ?? 0}`)
          .join("\n");

        // 타이머(클라에서 표시만)
        if (s.phase === "running" && s.endsAt) {
          const leftMs = Math.max(0, s.endsAt - Date.now());
          timer.textContent = `${Math.ceil(leftMs / 1000)}초`;
        } else {
          timer.textContent = "-";
        }
      }

      // 매 200ms마다 타이머 표시 갱신(서버 state는 그대로, 표시만 갱신)
      let lastState = null;
      setInterval(() => {
        if (lastState) renderState(lastState);
      }, 200);

      socket.on("state", (s) => {
        lastState = s;
        renderState(s);
      });

      socket.on("bidRejected", (e) => {
        setMsg(e?.reason ?? "입찰이 거절되었습니다.");
      });

      $("#btn").addEventListener("click", () => {
        const name = $("#name").value || "익명";
        const price = Number($("#price").value || 0);
        socket.emit("bid", { name, price });
      });

      if (isAdmin) {
        $("#start").addEventListener("click", () => socket.emit("admin:start"));
        $("#end").addEventListener("click", () => socket.emit("admin:end"));
        $("#reset").addEventListener("click", () => socket.emit("admin:reset"));
      }
    </script>
  </body>
</html>
